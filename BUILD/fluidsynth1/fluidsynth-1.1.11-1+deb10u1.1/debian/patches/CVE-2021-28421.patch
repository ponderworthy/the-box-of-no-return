Origin: backport, commit:005719628aef0bd48dc7b2f860c7e4ca16b81044
Bug: https://github.com/FluidSynth/fluidsynth/issues/808
Bug-Debian: https://bugs.debian.org/987168

--- a/src/sfloader/fluid_defsfont.c
+++ b/src/sfloader/fluid_defsfont.c
@@ -2706,7 +2706,7 @@
 static int
 load_pgen (int size, SFData * sf, FILE * fd)
 {
-  fluid_list_t *p, *p2, *p3, *dup, **hz = NULL;
+  fluid_list_t *p, *p2, *p3, *dup, **hz = NULL, *start_of_zone_list;
   SFZone *z;
   SFGen *g;
   SFGenAmount genval;
@@ -2718,7 +2718,7 @@
     {				/* traverse through all presets */
       gzone = FALSE;
       discarded = FALSE;
-      p2 = ((SFPreset *) (p->data))->zone;
+      start_of_zone_list = p2 = ((SFPreset *) (p->data))->zone;
       if (p2)
 	hz = &p2;
       while (p2)
@@ -2829,10 +2829,13 @@
 		}
 	      else
 		{		/* previous global zone exists, discard */
+		  p2 = fluid_list_next(p2); /* advance to next zone before deleting the current list element */
 		  FLUID_LOG (FLUID_WARN,
 		    _("Preset \"%s\": Discarding invalid global zone"),
 		    ((SFPreset *) (p->data))->name);
-		  sfont_zone_delete (sf, hz, (SFZone *) (p2->data));
+		  fluid_list_remove (start_of_zone_list, z);
+		  sfont_free_zone(z);
+		  continue;
 		}
 	    }
 
@@ -3057,7 +3060,7 @@
 static int
 load_igen (int size, SFData * sf, FILE * fd)
 {
-  fluid_list_t *p, *p2, *p3, *dup, **hz = NULL;
+  fluid_list_t *p, *p2, *p3, *dup, **hz = NULL, *start_of_zone_list;
   SFZone *z;
   SFGen *g;
   SFGenAmount genval;
@@ -3069,7 +3072,7 @@
     {				/* traverse through all instruments */
       gzone = FALSE;
       discarded = FALSE;
-      p2 = ((SFInst *) (p->data))->zone;
+      start_of_zone_list = p2 = ((SFInst *) (p->data))->zone;
       if (p2)
 	hz = &p2;
       while (p2)
@@ -3178,11 +3181,15 @@
 		    }
 		}
 	      else
-		{		/* previous global zone exists, discard */
+		{
+		  p2 = fluid_list_next(p2); /* advance to next zone before deleting the current list element */
+		  /* previous global zone exists, discard */
 		  FLUID_LOG (FLUID_WARN,
 		    _("Instrument \"%s\": Discarding invalid global zone"),
 		    ((SFInst *) (p->data))->name);
-		  sfont_zone_delete (sf, hz, (SFZone *) (p2->data));
+		  fluid_list_remove (start_of_zone_list, z);
+		  sfont_free_zone(z);
+		  continue;
 		}
 	    }
 
